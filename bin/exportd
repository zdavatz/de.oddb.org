#!/usr/bin/env ruby

$: << File.expand_path('../lib', File.dirname(__FILE__))
$KCODE = 'u'

require 'drb'
require 'logger'
require 'oddb/config'
require 'oddb/drugs'
require 'oddb/util'
require 'oddb/persistence'
require 'oddb/export'
require 'encoding/character/utf-8'

module ODDB
  log_file = @config.log_file_export
  if(log_file.is_a?(String))
    FileUtils.mkdir_p(File.dirname(log_file))
    log_file = File.open(log_file, 'a')
    at_exit { log_file.close }
  end
  logger = Logger.new(log_file)
  logger.level = Logger.const_get(@config.log_level_export)
  @logger = logger

  Currency = DRbObject.new(nil, @config.currency_rates)

  begin
    server = ODDB::Export::Server
    server.extend(DRbUndumped)
    @server = server

    url = @config.server_url_export
    url.untaint
    DRb.start_service(url, server)
    $SAFE = 1
    logger.info('start') { 
      sprintf("starting export-server on %s", url) }
    DRb.thread.join
  rescue Exception => error
    logger.error('fatal') { error }
    raise
  end
end
